<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizarreada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .screen {
            display: none;
            min-height: 100vh;
        }
        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .user-button {
            transition: background-color 0.3s ease;
        }
        .user-button.selected {
            background-color: #3b82f6;
            color: white;
        }
        .user-button.disabled {
            background-color: #4b5563; /* gray-600 */
            color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        #drawing-canvas {
            border: 2px solid #4a5568;
            cursor: crosshair;
            touch-action: none;
        }
        .word-choice-button {
            transition: background-color 0.2s ease-in-out;
        }
        .control-button {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
        }
        .control-button.active {
            background-color: #0ea5e9; /* sky-500 */
            color: white;
            transform: scale(1.05);
        }
        .color-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: border-color 0.2s ease-in-out, transform 0.1s ease;
        }
        .color-button.active {
            border-color: #0ea5e9; /* sky-500 */
            transform: scale(1.1);
        }
        .score-entry {
            transition: background-color 0.3s ease;
        }
        .score-entry.highlight {
            background-color: #2563eb; /* blue-600 */
        }
        #game-over-screen ul li {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
        }
        #game-over-screen ul li:nth-child(1) { background-color: #c084fcAA; } /* purple-400 with alpha */
        #game-over-screen ul li:nth-child(2) { background-color: #a78bfaAA; } /* violet-400 with alpha */
        #game-over-screen ul li:nth-child(3) { background-color: #7c3aedAA; } /* violet-600 with alpha */

    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 text-white antialiased">

<div id="password-screen" class="screen active p-4">
    <div class="bg-slate-700 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
        <h1 class="text-3xl sm:text-4xl font-bold mb-6 text-sky-400">Pizarreada</h1>
        <p class="mb-2 text-slate-300">Ingresa la contraseña para unirte:</p>
        <input type="password" id="password-input" class="w-full p-3 mb-4 bg-slate-800 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none" placeholder="Contraseña">
        <button id="password-submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold p-3 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
            Ingresar
        </button>
        <p id="password-error" class="text-red-400 mt-4 text-sm">&nbsp;</p>
        <p id="ws-status" class="text-xs text-slate-400 mt-3">&nbsp;</p>
    </div>
</div>

<div id="user-selection-screen" class="screen p-4">
    <div class="bg-slate-700 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-lg text-center">
        <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-sky-400">¿Quién eres?</h2>
        <div id="user-list" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6 max-h-72 overflow-y-auto pr-2">
        </div>
        <button id="user-select-submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-lg transition duration-200 ease-in-out transform hover:scale-105" disabled>
            Confirmar Identidad
        </button>
        <p id="user-select-error" class="text-red-400 mt-4 text-sm">&nbsp;</p>
    </div>
</div>

<div id="lobby-screen" class="screen p-4">
    <div class="bg-slate-700 p-6 rounded-xl shadow-2xl w-full max-w-2xl flex flex-col h-[90vh] sm:h-auto sm:max-h-[90vh]">
        <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-sky-400 text-center">Sala de Espera</h2>
        <p class="text-center text-slate-300 mb-1">Bienvenido/a, <span id="lobby-username" class="font-semibold text-sky-300"></span>!</p>
        <p class="text-center text-slate-400 text-sm mb-4">Jugadores listos: <span id="ready-count">0</span>/<span id="total-players-lobby">0</span></p>

        <div class="flex-grow flex flex-col sm:flex-row gap-4 overflow-hidden">
            <div class="sm:w-1/3 bg-slate-800 p-4 rounded-lg">
                <h3 class="font-semibold mb-2 text-lg text-sky-400">Conectados:</h3>
                <ul id="connected-users-list" class="space-y-1 text-slate-300 text-sm"></ul>
                <h3 class="font-semibold mt-4 mb-2 text-lg text-sky-400">Puntajes:</h3>
                <ul id="player-scores-lobby" class="space-y-1 text-slate-300 text-sm"></ul>
            </div>
            <div class="sm:w-2/3 flex flex-col bg-slate-800 p-4 rounded-lg">
                <h3 class="font-semibold mb-2 text-lg text-sky-400">Chat del Lobby</h3>
                <div id="lobby-chat-messages" class="chat-messages flex-grow bg-slate-900 p-3 rounded-md overflow-y-auto mb-3 h-48 sm:h-auto border border-slate-600"></div>
                <div class="flex gap-2">
                    <input type="text" id="lobby-chat-input" class="flex-grow p-2 bg-slate-600 border border-slate-500 rounded-lg text-white focus:ring-1 focus:ring-sky-500 outline-none" placeholder="Escribe un mensaje...">
                    <button id="lobby-chat-send" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg transition duration-150">Enviar</button>
                </div>
            </div>
        </div>
        <button id="start-game-button" class="w-full mt-6 bg-orange-500 hover:bg-orange-600 text-white font-bold p-3 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
            ¡Estoy Listo!
        </button>
        <p id="lobby-message" class="text-center text-yellow-400 mt-3 text-sm">&nbsp;</p>
    </div>
</div>

<div id="game-screen" class="screen p-2 sm:p-4">
    <div class="bg-slate-700 p-3 sm:p-6 rounded-xl shadow-2xl w-full max-w-4xl flex flex-col h-[95vh] sm:max-h-[90vh]">
        <div class="flex justify-between items-center mb-3 sm:mb-4">
            <div>
                <h2 class="text-xl sm:text-3xl font-bold text-green-400">¡A Dibujar!</h2>
                <p class="text-sm text-slate-300">Turno de: <span id="game-current-drawer" class="font-semibold text-sky-300"></span></p>
                <p class="text-sm text-slate-400">Turno actual: <span id="turn-counter">--/--</span></p>
            </div>
            <div class="text-right">
                <p id="game-score-display" class="text-md sm:text-lg text-amber-400">Puntos: <span id="current-player-score">0</span></p>
                <p class="text-lg sm:text-xl font-semibold text-red-400">Tiempo: <span id="game-timer">--</span></p>
            </div>
        </div>

        <div id="word-selection-area" class="mb-4 text-center hidden">
            <h3 class="text-lg sm:text-xl font-semibold mb-2 text-yellow-400">Elige una palabra para dibujar:</h3>
            <div id="word-choices" class="flex flex-wrap justify-center gap-2 sm:gap-3"></div>
            <p class="mt-2 text-sm text-slate-400">Tienes <span id="word-select-timer">20</span> segundos.</p>
        </div>

        <div class="flex-grow flex flex-col lg:flex-row gap-3 sm:gap-4 overflow-hidden">
            <div class="lg:w-2/3 flex flex-col items-center">
                <p class="mb-1 text-sm text-slate-300 h-5">Palabra a dibujar: <span id="chosen-word-display" class="font-bold text-xl text-lime-400"></span></p>
                <canvas id="drawing-canvas" width="500" height="400" class="bg-white rounded-lg shadow-md w-full max-w-full"></canvas>
                <div id="drawing-controls" class="mt-3 p-2 bg-slate-800 rounded-lg flex flex-wrap justify-center items-center gap-2 sm:gap-3 w-full max-w-md">
                    <div id="color-palette" class="flex gap-2"></div>
                    <button id="eraser-button" class="control-button bg-slate-600 hover:bg-slate-500 text-white font-medium py-1.5 px-3 rounded-md text-sm">Goma</button>
                    <button id="clear-canvas-button" class="control-button bg-red-500 hover:bg-red-600 text-white font-medium py-1.5 px-3 rounded-md text-sm">Limpiar</button>
                    <input type="range" id="brush-size" min="1" max="50" value="3" class="w-24 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-sky-500">
                </div>
            </div>

            <div class="lg:w-1/3 flex flex-col bg-slate-800 p-3 sm:p-4 rounded-lg h-64 lg:h-auto">
                <h3 class="font-semibold mb-2 text-md sm:text-lg text-sky-400">Chat del Juego</h3>
                <div id="game-chat-messages" class="chat-messages flex-grow bg-slate-900 p-2 sm:p-3 rounded-md overflow-y-auto mb-2 sm:mb-3 border border-slate-600"></div>
                <div class="flex gap-2">
                    <input type="text" id="game-chat-input" class="flex-grow p-2 bg-slate-600 border border-slate-500 rounded-lg text-white focus:ring-1 focus:ring-sky-500 outline-none" placeholder="Adivina o comenta...">
                    <button id="game-chat-send" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold px-3 py-2 rounded-lg transition duration-150 text-sm sm:text-base">Enviar</button>
                </div>
                <div id="turn-end-message" class="mt-3 text-center text-yellow-300 p-2 bg-slate-700 rounded hidden"></div>
            </div>
        </div>

        <button id="back-to-lobby-button" class="w-full sm:w-auto mt-4 sm:mt-6 bg-red-500 hover:bg-red-600 text-white font-semibold p-2 sm:p-3 rounded-lg transition duration-200 self-center">
            Salir de la Partida
        </button>
    </div>
</div>

<div id="game-over-screen" class="screen p-4">
    <div class="bg-slate-700 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
        <h1 class="text-3xl sm:text-4xl font-bold mb-6 text-sky-400">¡Juego Terminado!</h1>
        <p id="game-over-reason" class="text-lg text-slate-300 mb-4"></p>
        <h2 class="text-2xl font-semibold mb-3 text-amber-400">Resultados Finales:</h2>
        <ul id="final-scores-list" class="space-y-2 text-left text-slate-200 mb-6">
        </ul>
        <button id="play-again-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-lg transition duration-200">
            Volver al Lobby
        </button>
    </div>
</div>


<script>
    // --- Application State ---
    let currentScreen = 'password-screen';
    let selectedUser = null;
    let selectedUserButton = null;
    const UNIVERSAL_PASSWORD = "comunidad";
    const availableUsers = [
        "Frodo", "Arwen", "Gandalf", "Galadriel", "Aragorn", "Sam", "Gimli",
        "Pippin", "Merry", "Legolas", "Saruman", "Elrond", "Boromir", "Bilbo"
    ];
    let currentChosenWord = "";
    let wordToGuess = "";
    let wordSelectionTimerId = null;
    let drawingTimerId = null;
    let currentDrawer = null;

    let ws = null;
    let connectedPlayersFromServer = [];
    let localUserIsReady = false;
    let playerScores = {};
    let playersWhoGuessedThisTurn = [];

    // Canvas state
    let canvas, ctx;
    let drawing = false;
    let lastX, lastY;
    let currentBrushColor = '#000000';
    let currentBrushSize = 3;
    let isEraserActive = false;
    const CANVAS_BACKGROUND_COLOR = '#FFFFFF';

    // --- DOM Elements ---
    const screens = {
        password: document.getElementById('password-screen'),
        userSelection: document.getElementById('user-selection-screen'),
        lobby: document.getElementById('lobby-screen'),
        game: document.getElementById('game-screen'),
        gameOver: document.getElementById('game-over-screen')
    };
    const passwordInput = document.getElementById('password-input');
    const passwordSubmit = document.getElementById('password-submit');
    const passwordError = document.getElementById('password-error');
    const wsStatusDiv = document.getElementById('ws-status');

    const userListDiv = document.getElementById('user-list');
    const userSelectSubmit = document.getElementById('user-select-submit');
    const userSelectError = document.getElementById('user-select-error');

    const lobbyUsername = document.getElementById('lobby-username');
    const lobbyChatMessages = document.getElementById('lobby-chat-messages');
    const lobbyChatInput = document.getElementById('lobby-chat-input');
    const lobbyChatSend = document.getElementById('lobby-chat-send');
    const startGameButton = document.getElementById('start-game-button');
    const readyCountSpan = document.getElementById('ready-count');
    const totalPlayersLobbySpan = document.getElementById('total-players-lobby');
    const connectedUsersListUl = document.getElementById('connected-users-list');
    const playerScoresLobbyUl = document.getElementById('player-scores-lobby');
    const lobbyMessage = document.getElementById('lobby-message');

    const gameCurrentDrawerSpan = document.getElementById('game-current-drawer');
    const gameTimerSpan = document.getElementById('game-timer');
    const currentPlayerScoreSpan = document.getElementById('current-player-score');
    const turnCounterSpan = document.getElementById('turn-counter');
    const wordSelectionArea = document.getElementById('word-selection-area');
    const wordChoicesDiv = document.getElementById('word-choices');
    const wordSelectTimerSpan = document.getElementById('word-select-timer');
    const chosenWordDisplay = document.getElementById('chosen-word-display');
    const drawingCanvas = document.getElementById('drawing-canvas');
    const gameChatMessages = document.getElementById('game-chat-messages');
    const gameChatInput = document.getElementById('game-chat-input');
    const gameChatSend = document.getElementById('game-chat-send');
    const backToLobbyButton = document.getElementById('back-to-lobby-button');
    const turnEndMessageDiv = document.getElementById('turn-end-message');

    const drawingControlsDiv = document.getElementById('drawing-controls');
    const colorPaletteDiv = document.getElementById('color-palette');
    const eraserButton = document.getElementById('eraser-button');
    const clearCanvasButton = document.getElementById('clear-canvas-button');
    const brushSizeSlider = document.getElementById('brush-size');

    const gameOverReasonP = document.getElementById('game-over-reason');
    const finalScoresListUl = document.getElementById('final-scores-list');
    const playAgainButton = document.getElementById('play-again-button');


    // --- WebSocket Functions ---
    function connectWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) return;
        ws = new WebSocket("ws://localhost:8080/ws");

        ws.onopen = () => {
            console.log("Conectado al servidor WebSocket.");
            wsStatusDiv.textContent = "Conectado al servidor.";
            wsStatusDiv.className = "text-xs text-green-400 mt-3";
            displayPasswordError('');
            navigateTo('userSelection');
            populateUserList();
        };

        ws.onmessage = (event) => {
            console.log("Mensaje del servidor:", event.data);
            try {
                const message = JSON.parse(event.data);
                handleServerMessage(message);
            } catch (error) {
                console.error("Error al parsear JSON del servidor:", error, event.data);
            }
        };

        ws.onerror = (error) => {
            console.error("Error de WebSocket:", error);
            wsStatusDiv.textContent = "Error de conexión. ¿Servidor activo?";
            wsStatusDiv.className = "text-xs text-red-400 mt-3";
        };

        ws.onclose = () => {
            console.log("Desconectado del servidor WebSocket.");
            wsStatusDiv.textContent = "Desconectado. Intenta recargar.";
            wsStatusDiv.className = "text-xs text-yellow-400 mt-3";
            if (currentScreen !== 'password') {
                navigateTo('password');
                passwordError.textContent = "Conexión perdida con el servidor.";
            }
            ws = null;
        };
    }

    function sendWsMessage(type, payload) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            const message = JSON.stringify({ type, payload });
            ws.send(message);
            console.log("Mensaje enviado:", message);
        } else {
            console.warn("WebSocket no conectado. No se pudo enviar:", type, payload);
        }
    }

    function handleServerMessage(message) {
        console.log("[CLIENT] Received message from server:", message);
        switch (message.type) {
            case "userListUpdate":
                connectedPlayersFromServer = message.payload.users || [];
                updateUserSelectionList();
                if (currentScreen === 'lobby') updateLobbyUI();
                break;
            case "chatMessage":
                if (message.payload && message.payload.username && message.payload.message) {
                    const chatBox = currentScreen === 'game' ? gameChatMessages : lobbyChatMessages;
                    addChatMessage(chatBox, message.payload.username, message.payload.message);
                }
                break;
            case "assignDrawerAndWords":
                console.log("[CLIENT] assignDrawerAndWords payload:", message.payload);
                currentDrawer = message.payload.drawerUsername;
                wordToGuess = "";
                playersWhoGuessedThisTurn = [];
                turnCounterSpan.textContent = `${message.payload.totalTurnsCompleted || '?'}/${message.payload.maxTurns || '?'}`;
                initTurn(message.payload.wordsToChoose || [], message.payload.duration || 20);
                break;
            case "drawingPhaseStart":
                console.log("[CLIENT] drawingPhaseStart payload:", message.payload);
                currentDrawer = message.payload.drawerUsername;
                const drawingDuration = message.payload.duration || 90;

                if (currentScreen !== 'game') {
                    console.warn("Received drawingPhaseStart but not in game screen. Navigating...");
                    navigateTo('game');
                }

                addChatMessage(gameChatMessages, null, `${currentDrawer} va a dibujar.`, true);

                if (selectedUser === currentDrawer) {
                    currentChosenWord = message.payload.wordToDraw;
                    chosenWordDisplay.textContent = currentChosenWord.toUpperCase();
                    drawingCanvas.classList.remove('opacity-50', 'pointer-events-none');
                    drawingControlsDiv.classList.remove('hidden');
                    drawingCanvas.focus();
                    addChatMessage(gameChatMessages, null, `¡Tu palabra es "${currentChosenWord.toUpperCase()}"! Comienza a dibujar.`, true);
                } else { // Adivinador
                    chosenWordDisplay.textContent = "Adivina...";
                    drawingCanvas.classList.remove('opacity-50');
                    drawingCanvas.classList.add('pointer-events-none');
                    drawingControlsDiv.classList.add('hidden');
                    addChatMessage(gameChatMessages, null, `${currentDrawer} ha comenzado a dibujar. ¡Adivina!`, true);
                }
                wordSelectionArea.classList.add('hidden');
                startTimer(drawingDuration, gameTimerSpan, () => {
                    // El servidor enviará "turnOver" si el tiempo se acaba.
                }, "s");
                break;
            case "drawAction":
                console.log("[CLIENT] drawAction payload:", message.payload);
                applyDrawAction(message.payload);
                break;
            case "guessCorrect":
                console.log("[CLIENT] guessCorrect payload:", message.payload);
                addChatMessage(gameChatMessages, null, `¡${message.payload.guesserUsername} ha adivinado! (+${message.payload.pointsGuesser} puntos para ${message.payload.guesserUsername}, +${message.payload.pointsDrawer} para ${currentDrawer})`, true, true);
                if ((message.payload.guesserUsername === selectedUser) && (!message.payload.isTurnOver)) {
                    gameChatInput.disabled = true;
                    gameChatInput.placeholder = "¡Adivinaste!";
                }
                playersWhoGuessedThisTurn.push(message.payload.guesserUsername);
                if (message.payload.isTurnOver && message.payload.wordRevealed) {
                    wordToGuess = message.payload.wordRevealed;
                    chosenWordDisplay.textContent = wordToGuess.toUpperCase();
                }
                break;
            case "scoreUpdate":
                console.log("[CLIENT] scoreUpdate payload:", message.payload);
                playerScores = message.payload.scores || {};
                updateScoresDisplay();
                break;
            case "turnOver":
                console.log("[CLIENT] turnOver payload:", message.payload);
                clearTimeout(drawingTimerId);
                drawingTimerId = null;
                wordToGuess = message.payload.wordRevealed;
                chosenWordDisplay.textContent = wordToGuess.toUpperCase();
                addChatMessage(gameChatMessages, null, `El turno terminó. La palabra era: ${wordToGuess.toUpperCase()}. Razón: ${message.payload.reason}`, true);
                turnEndMessageDiv.textContent = `El turno ha terminado. La palabra era: ${wordToGuess.toUpperCase()}.`;
                turnEndMessageDiv.classList.remove('hidden');
                // gameChatInput.disabled = true;
                drawingCanvas.classList.add('opacity-50', 'pointer-events-none');
                break;
            case "gameOver":
                console.log("[CLIENT] gameOver payload:", message.payload);
                clearTimeout(drawingTimerId);
                clearTimeout(wordSelectionTimerId);
                playerScores = message.payload.scores || {};
                gameOverReasonP.textContent = message.payload.reason || "El juego ha finalizado.";
                finalScoresListUl.innerHTML = '';

                const sortedUsernames = message.payload.sortedUsers || Object.keys(playerScores).sort((a, b) => playerScores[b] - playerScores[a]);

                sortedUsernames.forEach((username, index) => {
                    const li = document.createElement('li');
                    li.classList.add('flex', 'justify-between', 'p-1.5', 'my-1', 'rounded-md');
                    const rankSpan = document.createElement('span');
                    rankSpan.textContent = `${index + 1}. ${username}`;
                    const scoreSpan = document.createElement('span');
                    scoreSpan.textContent = `${playerScores[username] || 0} puntos`;
                    li.appendChild(rankSpan);
                    li.appendChild(scoreSpan);
                    finalScoresListUl.appendChild(li);
                });
                navigateTo('gameOver');
                break;
            default:
                console.warn("Tipo de mensaje desconocido del servidor:", message.type);
        }
    }

    // --- Utility Functions ---
    function navigateTo(screenId) {
        console.log(`[CLIENT] Navigating to screen: ${screenId}`);
        Object.values(screens).forEach(screen => screen.classList.remove('active'));
        if (screens[screenId]) screens[screenId].classList.add('active');
        else console.error(`Screen with id ${screenId} not found!`);
        currentScreen = screenId;
    }
    function displayPasswordError(message) { passwordError.textContent = message; }
    function displayUserSelectError(message) { userSelectError.textContent = message; }
    function addChatMessage(chatBox, user, message, isSystem = false, highlight = false) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('mb-1.5', 'text-sm', 'break-words', 'p-1', 'rounded');
        if (isSystem) {
            messageElement.classList.add('text-amber-300', 'italic', 'bg-slate-700');
            messageElement.textContent = message;
        } else {
            messageElement.classList.add('text-slate-200');
            const userSpan = document.createElement('span');
            userSpan.classList.add('font-semibold');
            userSpan.style.color = getPlayerColor(user);
            userSpan.textContent = `${user}: `;
            messageElement.appendChild(userSpan);
            messageElement.append(document.createTextNode(message));
        }
        if (highlight) messageElement.classList.add('bg-sky-700', 'font-semibold');
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    function getPlayerColor(username) {
        let hash = 0;
        for (let i = 0; i < username.length; i++) hash = username.charCodeAt(i) + ((hash << 5) - hash);
        const colors = ['#fb923c', '#f87171', '#a78bfa', '#60a5fa', '#34d399', '#facc15'];
        return colors[Math.abs(hash) % colors.length];
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        initCanvas();
        initDrawingControls();
        initializeScores();
        updateScoresDisplay();
        navigateTo('password');
        passwordInput.focus();
        playAgainButton.addEventListener('click', () => {
            if(ws && ws.readyState === WebSocket.OPEN && selectedUser) {
                sendWsMessage("playerReady", { username: selectedUser, isReady: false });
            }
            navigateTo('lobby');
        });
    });

    // --- Score Management ---
    function initializeScores() {
        playerScores = {};
        availableUsers.forEach(user => playerScores[user] = 0);
    }
    function updateScoresDisplay() {
        playerScoresLobbyUl.innerHTML = '';
        const sortedScores = Object.entries(playerScores).sort(([,a],[,b]) => b-a);
        sortedScores.forEach(([name, score]) => {
            if (connectedPlayersFromServer.find(p => p.username === name) || playerScores[name] !== undefined) {
                const li = document.createElement('li');
                li.classList.add('score-entry', 'p-1', 'rounded-md');
                li.textContent = `${name}: ${score} puntos`;
                if (name === selectedUser) li.classList.add('text-sky-300', 'font-bold');
                playerScoresLobbyUl.appendChild(li);
            }
        });
        if (selectedUser && playerScores.hasOwnProperty(selectedUser)) {
            currentPlayerScoreSpan.textContent = playerScores[selectedUser];
        } else {
            currentPlayerScoreSpan.textContent = '0';
        }
    }

    // --- Password Screen Logic ---
    passwordSubmit.addEventListener('click', handlePasswordSubmit);
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handlePasswordSubmit(); });
    function handlePasswordSubmit() {
        if (passwordInput.value === UNIVERSAL_PASSWORD) connectWebSocket();
        else {
            displayPasswordError('Contraseña incorrecta. Intenta de nuevo.');
            passwordInput.value = '';
            passwordInput.focus();
        }
    }

    // --- User Selection Screen Logic ---
    function populateUserList() {
        userListDiv.innerHTML = '';
        availableUsers.forEach(user => {
            const button = document.createElement('button');
            button.textContent = user;
            button.classList.add('user-button', 'w-full', 'text-sm', 'sm:text-base', 'bg-slate-600', 'hover:bg-slate-500', 'text-white', 'font-medium', 'py-2', 'px-3', 'rounded-lg', 'transition', 'duration-150');
            button.dataset.username = user;
            const isTaken = connectedPlayersFromServer.some(p => p.username === user && p.username !== selectedUser);
            if (isTaken) {
                button.disabled = true;
                button.classList.add('disabled');
                button.title = "Este nombre ya está en uso";
            }
            button.addEventListener('click', () => {
                if (button.disabled) return;
                if (selectedUserButton) {
                    selectedUserButton.classList.remove('selected', 'bg-sky-500');
                    selectedUserButton.classList.add('bg-slate-600', 'hover:bg-slate-500');
                }
                selectedUser = user;
                selectedUserButton = button;
                button.classList.add('selected', 'bg-sky-500');
                button.classList.remove('bg-slate-600', 'hover:bg-slate-500');
                userSelectSubmit.disabled = false;
                userSelectError.textContent = '';
            });
            userListDiv.appendChild(button);
        });
    }
    function updateUserSelectionList() {
        if (currentScreen === 'userSelection') populateUserList();
    }
    userSelectSubmit.addEventListener('click', handleUserSelectSubmit);
    function handleUserSelectSubmit() {
        if (selectedUser) {
            displayUserSelectError('');
            lobbyUsername.textContent = selectedUser;
            localUserIsReady = false;
            sendWsMessage("userIdentify", { username: selectedUser });
            if (!playerScores.hasOwnProperty(selectedUser)) playerScores[selectedUser] = 0;
            updateScoresDisplay();
            navigateTo('lobby');
        } else {
            displayUserSelectError('Por favor, selecciona un usuario.');
        }
    }

    // --- Lobby Screen Logic ---
    lobbyChatSend.addEventListener('click', () => handleChatSend(lobbyChatInput, lobbyChatMessages, false));
    lobbyChatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChatSend(lobbyChatInput, lobbyChatMessages, false); });
    startGameButton.addEventListener('click', handleReadyOrStartGame);

    function handleChatSend(inputElement, messagesBox, isGameContext) {
        const message = inputElement.value.trim();
        if (!message || !selectedUser) {
            inputElement.focus(); return;
        }
        sendWsMessage("chatMessage", { username: selectedUser, message: message });
        inputElement.value = '';
        inputElement.focus();
    }

    function updateLobbyUI() {
        connectedUsersListUl.innerHTML = '';
        let readyCount = 0;
        connectedPlayersFromServer.forEach(player => {
            const li = document.createElement('li');
            li.textContent = `${player.username} ${player.isReady ? '✔️' : '⏳'}`;
            if (player.username === selectedUser) li.classList.add('font-bold', 'text-sky-300');
            connectedUsersListUl.appendChild(li);
            if (player.isReady) readyCount++;
        });
        readyCountSpan.textContent = readyCount;
        totalPlayersLobbySpan.textContent = connectedPlayersFromServer.length;
        const currentUserData = connectedPlayersFromServer.find(p => p.username === selectedUser);
        localUserIsReady = currentUserData ? currentUserData.isReady : false;

        if (selectedUser === "Gandalf") {
            startGameButton.textContent = localUserIsReady ? "¡Esperando (Gandalf)!" : "¡Comenzar Ya (Gandalf)!";
            startGameButton.disabled = false;
            lobbyMessage.textContent = "Modo desarrollador: Puedes iniciar solo o esperar a otros.";
        } else {
            startGameButton.textContent = localUserIsReady ? "¡Esperando Jugadores!" : "¡Estoy Listo!";
            startGameButton.disabled = localUserIsReady;
            lobbyMessage.textContent = localUserIsReady ? "Esperando a que todos estén listos..." : "Presiona cuando estés listo.";
        }
        updateScoresDisplay();
    }

    function handleReadyOrStartGame() {
        if (selectedUser === "Gandalf") {
            if (!localUserIsReady) {
                localUserIsReady = true;
                sendWsMessage("playerReady", { username: selectedUser, isReady: true });
            } else {
                sendWsMessage("requestStartGame", { username: selectedUser });
                lobbyMessage.textContent = "Intentando iniciar el juego como Gandalf...";
            }
        } else {
            if (!localUserIsReady) {
                localUserIsReady = true;
                sendWsMessage("playerReady", { username: selectedUser, isReady: true });
            }
        }
    }

    // --- Game Screen Logic ---
    gameChatSend.addEventListener('click', () => handleChatSend(gameChatInput, gameChatMessages, true));
    gameChatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChatSend(gameChatInput, gameChatMessages, true); });
    backToLobbyButton.addEventListener('click', handleBackToLobby);

    function initTurn(wordsToChooseByServer = [], wordSelectDuration = 20) {
        console.log(`[CLIENT ${selectedUser}] initTurn. CurrentDrawer: ${currentDrawer}.`);
        navigateTo('game');

        gameChatMessages.innerHTML = '';
        addChatMessage(gameChatMessages, null, `Nuevo turno. ${currentDrawer} va a dibujar.`, true);

        gameCurrentDrawerSpan.textContent = currentDrawer || "Nadie";
        chosenWordDisplay.textContent = "";
        wordSelectionArea.classList.add('hidden');
        drawingControlsDiv.classList.add('hidden');

        turnEndMessageDiv.classList.add('hidden');
        turnEndMessageDiv.textContent = '';
        // playersWhoGuessedThisTurn se resetea en el handler de 'assignDrawerAndWords'

        clearCanvasFull();

        const amIDrawer = (selectedUser === currentDrawer);

        if (amIDrawer) {
            gameChatInput.disabled = true;
            gameChatInput.placeholder = "Estás dibujando...";
            wordSelectionArea.classList.remove('hidden');
            chosenWordDisplay.textContent = "Eligiendo...";
            wordChoicesDiv.innerHTML = '';
            drawingCanvas.classList.add('opacity-50', 'pointer-events-none'); // Canvas deshabilitado durante selección

            if (wordsToChooseByServer.length > 0) {
                wordsToChooseByServer.forEach(word => {
                    const button = document.createElement('button');
                    button.textContent = word;
                    button.classList.add('word-choice-button', 'bg-sky-500', 'hover:bg-sky-600', 'text-white', 'font-semibold', 'py-2', 'px-4', 'rounded-lg', 'transition');
                    button.addEventListener('click', () => handleWordSelectedByDrawer(word));
                    wordChoicesDiv.appendChild(button);
                });
                startTimer(wordSelectDuration, wordSelectTimerSpan, () => {
                    if (wordChoicesDiv.children.length > 0 && selectedUser === currentDrawer && chosenWordDisplay.textContent === "Eligiendo...") {
                        const activeButtons = Array.from(wordChoicesDiv.children).filter(btn => !btn.disabled);
                        if (activeButtons.length > 0) {
                            const randomWord = wordsToChooseByServer[Math.floor(Math.random() * wordsToChooseByServer.length)];
                            handleWordSelectedByDrawer(randomWord);
                        }
                    }
                }, "s restantes");
            } else {
                chosenWordDisplay.textContent = "Esperando palabras del servidor...";
            }
        } else { // Adivinador
            gameChatInput.disabled = false;
            gameChatInput.placeholder = "Adivina la palabra...";
            drawingCanvas.classList.remove('opacity-50');
            drawingCanvas.classList.add('pointer-events-none');
            wordSelectionArea.classList.add('hidden');
            chosenWordDisplay.textContent = "Adivina...";
        }
        updateScoresDisplay();
    }

    function handleWordSelectedByDrawer(word) {
        clearTimeout(wordSelectionTimerId);
        Array.from(wordChoicesDiv.children).forEach(btn => btn.disabled = true);
        sendWsMessage("wordChosenByDrawer", { username: selectedUser, chosenWord: word });
        chosenWordDisplay.textContent = "Palabra enviada...";
    }

    function startTimer(duration, displayElement, onEndCallback, suffix = "s") {
        if (displayElement === wordSelectTimerSpan && wordSelectionTimerId) clearTimeout(wordSelectionTimerId);
        if (displayElement === gameTimerSpan && drawingTimerId) clearTimeout(drawingTimerId);
        let timeLeft = duration;
        displayElement.textContent = `${timeLeft}${suffix}`;
        function tick() {
            timeLeft--;
            displayElement.textContent = `${timeLeft}${suffix}`;
            if (timeLeft > 0) {
                const timer = setTimeout(tick, 1000);
                if (displayElement === wordSelectTimerSpan) wordSelectionTimerId = timer;
                if (displayElement === gameTimerSpan) drawingTimerId = timer;
            } else {
                displayElement.textContent = `0${suffix}`;
                onEndCallback();
            }
        }
        const initialTimer = setTimeout(tick, 1000);
        if (displayElement === wordSelectTimerSpan) wordSelectionTimerId = initialTimer;
        if (displayElement === gameTimerSpan) drawingTimerId = initialTimer;
    }

    function handleBackToLobby() {
        clearTimeout(wordSelectionTimerId);
        clearTimeout(drawingTimerId);
        wordSelectionTimerId = null; drawingTimerId = null;
        currentChosenWord = ""; wordToGuess = "";
        chosenWordDisplay.textContent = "";
        wordSelectionArea.classList.add('hidden');
        gameTimerSpan.textContent = "--";
        turnCounterSpan.textContent = "--/--";
        wordSelectTimerSpan.textContent = "20";
        drawingControlsDiv.classList.add('hidden');
        gameChatInput.disabled = false;
        gameChatInput.placeholder = "Adivina o comenta...";
        turnEndMessageDiv.classList.add('hidden');
        localUserIsReady = false;

        if(ws && ws.readyState === WebSocket.OPEN && selectedUser) {
            sendWsMessage("playerReady", { username: selectedUser, isReady: false });
            if (currentScreen === 'game') sendWsMessage("playerLeaveGame", {username: selectedUser});
        }
        navigateTo('lobby');
    }

    // --- Canvas Drawing Logic ---
    function applyDrawAction(payload) {
        if (!ctx) return;

        if (payload.username === selectedUser && selectedUser === currentDrawer) {
            if (payload.action === "start" || payload.action === "draw" || payload.action === "end") {
                return;
            }
        }

        ctx.strokeStyle = payload.isEraser ? CANVAS_BACKGROUND_COLOR : payload.color;
        ctx.lineWidth = payload.size;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.globalCompositeOperation = 'source-over';

        switch (payload.action) {
            case "start":
                ctx.beginPath();
                ctx.moveTo(payload.x, payload.y);
                break;
            case "draw":
                ctx.beginPath();
                ctx.moveTo(payload.fromX, payload.fromY);
                ctx.lineTo(payload.toX, payload.toY);
                ctx.stroke();
                break;
            case "end":
                break;
            case "clear":
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (payload.username === selectedUser && selectedUser === currentDrawer) {
                    isEraserActive = false;
                    currentBrushColor = '#000000';
                    currentBrushSize = parseFloat(brushSizeSlider.value) || 3;
                    eraserButton.classList.remove('active');
                    const blackButton = document.querySelector('#color-palette .color-button[data-color="#000000"]');
                    if (blackButton) updateActiveColorButton(blackButton);
                }
                break;
            case "controlChange":
                if (payload.username === selectedUser && selectedUser === currentDrawer) {
                    if (payload.control === "color") {
                        isEraserActive = payload.isEraser;
                        currentBrushColor = payload.color;
                        eraserButton.classList.toggle('active', isEraserActive);
                        updateActiveColorButton(isEraserActive ? null : document.querySelector(`#color-palette .color-button[data-color="${payload.color}"]`));
                    } else if (payload.control === "eraser") {
                        isEraserActive = payload.isEraser;
                        currentBrushColor = payload.color;
                        eraserButton.classList.toggle('active', isEraserActive);
                        updateActiveColorButton(isEraserActive ? null : document.querySelector(`#color-palette .color-button[data-color="${currentBrushColor}"]`));
                    } else if (payload.control === "brushSize") {
                        currentBrushSize = payload.size;
                        brushSizeSlider.value = currentBrushSize;
                    }
                }
                break;
        }
    }


    function initCanvas() {
        canvas = drawingCanvas; ctx = canvas.getContext('2d');
        ctx.strokeStyle = currentBrushColor; ctx.lineWidth = currentBrushSize;
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        canvas.style.backgroundColor = CANVAS_BACKGROUND_COLOR;
        canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawingTouch, { passive: false });
        canvas.addEventListener('touchmove', drawTouch, { passive: false });
        canvas.addEventListener('touchend', stopDrawingTouch); canvas.addEventListener('touchcancel', stopDrawingTouch);
    }
    function initDrawingControls() {
        const colors = ['#000000', '#FF0000', '#0000FF', '#008000', '#FFFF00', '#FFFFFF'];
        const colorNames = ['Negro', 'Rojo', 'Azul', 'Verde', 'Amarillo', 'Borrador (Blanco)'];
        colorPaletteDiv.innerHTML = '';
        colors.forEach((color, index) => {
            const button = document.createElement('button');
            button.classList.add('color-button'); button.style.backgroundColor = color;
            button.dataset.color = color; button.setAttribute('aria-label', `Seleccionar color ${colorNames[index]}`);
            if (color === currentBrushColor && !isEraserActive) button.classList.add('active');
            button.addEventListener('click', () => {
                if (selectedUser !== currentDrawer) return;
                isEraserActive = false; currentBrushColor = color;
                eraserButton.classList.remove('active');
                updateActiveColorButton(button);
                sendWsMessage("drawAction", { action: "controlChange", control: "color", value: color, isEraser: false, color: currentBrushColor, size: currentBrushSize });
            });
            colorPaletteDiv.appendChild(button);
        });
        eraserButton.addEventListener('click', () => {
            if (selectedUser !== currentDrawer) return;
            isEraserActive = true;
            eraserButton.classList.add('active');
            updateActiveColorButton(null);
            sendWsMessage("drawAction", { action: "controlChange", control: "eraser", value: "true", isEraser: true, color: CANVAS_BACKGROUND_COLOR, size: currentBrushSize });
        });
        clearCanvasButton.addEventListener('click', () => {
            if (selectedUser === currentDrawer) {
                clearCanvasFull();
                sendWsMessage("drawAction", { action: "clear", color: currentBrushColor, size: currentBrushSize, isEraser: isEraserActive });
            }
        });
        brushSizeSlider.addEventListener('input', (e) => {
            if (selectedUser !== currentDrawer) { e.target.value = currentBrushSize; return; }
            currentBrushSize = parseFloat(e.target.value);
            sendWsMessage("drawAction", { action: "controlChange", control: "brushSize", value: currentBrushSize.toString(), size: currentBrushSize, color: currentBrushColor, isEraser: isEraserActive });
        });
        drawingControlsDiv.classList.add('hidden');
    }
    function updateActiveColorButton(activeButton) {
        document.querySelectorAll('#color-palette .color-button').forEach(btn => btn.classList.remove('active'));
        if (activeButton) activeButton.classList.add('active');
    }
    function getMousePos(evt) {
        const rect = canvas.getBoundingClientRect();
        return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
    }
    function getTouchPos(evt) {
        const rect = canvas.getBoundingClientRect();
        return { x: evt.touches[0].clientX - rect.left, y: evt.touches[0].clientY - rect.top };
    }
    function startDrawing(e) {
        if (e.buttons !== 1 || selectedUser !== currentDrawer || currentScreen !== 'game' || drawingCanvas.classList.contains('pointer-events-none')) return;
        drawing = true; const pos = getMousePos(e);
        [lastX, lastY] = [pos.x, pos.y];
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        sendWsMessage("drawAction", { action: "start", x: pos.x, y: pos.y, color: currentBrushColor, size: currentBrushSize, isEraser: isEraserActive });
    }
    function draw(e) {
        if (!drawing || e.buttons !== 1 || selectedUser !== currentDrawer || currentScreen !== 'game' || drawingCanvas.classList.contains('pointer-events-none')) return;
        const pos = getMousePos(e);
        ctx.lineWidth = currentBrushSize;
        ctx.strokeStyle = isEraserActive ? CANVAS_BACKGROUND_COLOR : currentBrushColor;
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();

        sendWsMessage("drawAction", { action: "draw", fromX: lastX, fromY: lastY, toX: pos.x, toY: pos.y, color: currentBrushColor, size: currentBrushSize, isEraser: isEraserActive });
        lastX = pos.x; lastY = pos.y;
    }
    function stopDrawing() {
        if (drawing) {
            drawing = false;
            ctx.beginPath();
            sendWsMessage("drawAction", { action: "end", color: currentBrushColor, size: currentBrushSize, isEraser: isEraserActive });
        }
    }
    function startDrawingTouch(e) {
        if (selectedUser !== currentDrawer || currentScreen !== 'game' || drawingCanvas.classList.contains('pointer-events-none')) return;
        e.preventDefault(); drawing = true; const pos = getTouchPos(e);
        [lastX, lastY] = [pos.x, pos.y];
        ctx.beginPath(); ctx.moveTo(lastX, lastY);
        sendWsMessage("drawAction", { action: "start", x: pos.x, y: pos.y, color: currentBrushColor, size: currentBrushSize, isEraser: isEraserActive });
    }
    function drawTouch(e) {
        if (!drawing || selectedUser !== currentDrawer || currentScreen !== 'game' || drawingCanvas.classList.contains('pointer-events-none')) return;
        e.preventDefault(); const pos = getTouchPos(e);
        ctx.lineWidth = currentBrushSize;
        ctx.strokeStyle = isEraserActive ? CANVAS_BACKGROUND_COLOR : currentBrushColor;
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        sendWsMessage("drawAction", { action: "draw", fromX: lastX, fromY: lastY, toX: pos.x, toY: pos.y, color: currentBrushColor, size: currentBrushSize, isEraser: isEraserActive });
        lastX = pos.x; lastY = pos.y;
    }
    function stopDrawingTouch() {
        if (drawing) {
            drawing = false;
            ctx.beginPath();
            sendWsMessage("drawAction", { action: "end", color: currentBrushColor, size: currentBrushSize, isEraser: isEraserActive });
        }
    }
    function clearCanvasFull() {
        // Se llama para todos al inicio del turno (initTurn) y por el dibujante explícitamente
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (selectedUser === currentDrawer) { // Si es el dibujante, resetear sus herramientas locales
            isEraserActive = false; currentBrushColor = '#000000';
            eraserButton.classList.remove('active');
            const blackButton = document.querySelector('#color-palette .color-button[data-color="#000000"]');
            if (blackButton) updateActiveColorButton(blackButton);
            else if (colorPaletteDiv.firstChild) updateActiveColorButton(colorPaletteDiv.firstChild);
        }
    }
</script>
</body>
</html>
